<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Making your first Phaser 3 Game - Part 10</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <!-- Phaser -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@v3.80.1/dist/phaser.min.js"></script>

    <style type="text/css">
        @font-face {
            font-family: "Press Start 2P";
            src: url("https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap") format("truetype");

            src: url(https://fonts.gstatic.com/s/pressstart2p/v15/e3t4euO8T-267oIAQAu6jDQyK3nYivN04w.woff2) format('woff2');
            src: url(https://fonts.gstatic.com/s/pressstart2p/v15/e3t4euO8T-267oIAQAu6jDQyK3nRivN04w.woff2) format('woff2');
            src: url(https://fonts.gstatic.com/s/pressstart2p/v15/e3t4euO8T-267oIAQAu6jDQyK3nWivN04w.woff2) format('woff2');
            src: url(https://fonts.gstatic.com/s/pressstart2p/v15/e3t4euO8T-267oIAQAu6jDQyK3nbivN04w.woff2) format('woff2');
            src: url(https://fonts.gstatic.com/s/pressstart2p/v15/e3t4euO8T-267oIAQAu6jDQyK3nVivM.woff2) format('woff2');
        }

        body {
            background-image: url("../assets/bg/phaser-planet-small.png");
            background-size: 20%;
            background-repeat: repeat;
        }

        #main, #game {
            margin: 0;
            font-family: 'Press Start 2P', cursive;
            text-transform: uppercase;
        }

        #content {
            width: 50% !important;
        }

        /* Main */
        #main {
            position: sticky;
        }

        /* Game */
        #game {
        }

        /* Game over */
        .game-over {
            position: fixed;
            top: 50%;
            left: 45%;
            transform: translate(-51%, -50%);
        }

        @media only screen and (max-width: 600px) {
            #content {
                width: 90% !important;
            }
        }
    </style>
</head>
<body>

<div id="main" class="py-12 sm:px-6 lg:px-8 h-screen flex items-center justify-center hidden">

    <div id="content">

        <ul id="list"
            role="list"
            class="divide-y divide-gray-100 overflow-hidden bg-white shadow-sm ring-8 ring-gray-900/4 sm:rounded-xl">

            <li class="px-4 py-5 sm:px-6">
                <div class="text-center text-3xl font-bold">
                    Would you like to play again?
                </div>
            </li>

            <li class="px-4 py-5 sm:px-6">
                <div class="text-center text-3xl font-bold">
                    <a href="/">
                        <button
                                class="rounded-md bg-white m-2 px-3.5 py-2.5 text-3xl font-bold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 uppercase">
                            Main Menu
                        </button>
                    </a>

                    <a href="/arcade">
                        <button
                                class="rounded-md bg-white m-2 px-3.5 py-2.5 text-3xl font-bold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 uppercase">
                            Play Again
                        </button>
                    </a>
                </div>
            </li>
        </ul>
    </div>

</div>

<div id="game" class="h-screen"></div>

<script type="text/javascript">

    let configDesktop = {
        type: Phaser.AUTO,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: {y: 300},
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        },
        // Allows Phaser canvas to be responsive to browser sizing
        scale: {
            mode: Phaser.Scale.FIT,
            autoCenter: Phaser.Scale.CENTER_BOTH,
            width: 800,
            height: 600,
        },
        device: 'desktop',
        instructions: 'Move with W, A, S, D',
        parent: 'game',
    };

    let configMobile = {
        type: Phaser.AUTO,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: {y: 300},
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        },
        // Allows Phaser canvas to be responsive to browser sizing
        scale: {
            mode: Phaser.Scale.FIT,
            autoCenter: Phaser.Scale.CENTER_BOTH,
            width: 800,
            height: 750,
        },
        device: 'mobile',
        instructions: 'Move by using the joystick',
        parent: 'game',
    };

    let player;
    let stars;
    let bombs;
    let sky;
    let skyIndex = 1;
    let platforms = [];
    let platformIndex = 1;
    let cursors;
    let score = 0;
    let gameOver = false;
    let scoreText;
    let instructions;
    let instructionsText;

    let game

    window.onload = function () {
        // Check if the user is accessing the page on a mobile device
        const isMobile = this.isMobile()

        if (isMobile) {
            game = new Phaser.Game(configMobile);
        } else {
            game = new Phaser.Game(configDesktop);
        }
    }

    function preload() {
        // Backgrounds
        this.load.image('sky1', '../../assets/bg/sky.png');
        this.load.image('sky2', '../../assets/bg/john-cosio-xCZ8ynsCfrw-unsplash.jpg');
        this.load.image('sky3', '../../assets/bg/john-cosio-RxjSW-seIp0-unsplash.jpg');
        this.load.image('sky4', '../../assets/bg/aleksandra-khaprenko-0PPw9irzLIw-unsplash.jpg');
        this.load.image('sky5', '../../assets/bg/nathan-dumlao-kME9jbKd--s-unsplash.jpg');
        this.load.image('sky6', '../../assets/bg/dan-asaki-K0mJQlbu9Yo-unsplash.jpg');
        this.load.image('ground', '../../assets/platform.png');
        this.load.image('ground-m', '../../assets/platform-50.png');
        this.load.image('ground-s', '../../assets/platform-25.png');
        this.load.image('star', '../../assets/star.png');
        this.load.image('bomb', '../../assets/bomb.png');

        // Player sprites
        this.load.spritesheet('dude1', '../../assets/dude.png', {frameWidth: 32, frameHeight: 48});
        this.load.spritesheet('dude2', '../../assets/piccolo.png', {frameWidth: 32, frameHeight: 48});

        let url;

        url = '../../assets/rexvirtualjoystickplugin.min.js';
        this.load.plugin('rexvirtualjoystickplugin', url, true);
    }

    function create() {
        //  A simple background for our game
        sky = this.add.image(400, 300, 'sky' + skyIndex);

        //  The platforms group contains the ground and the 2 ledges we can jump on
        //  Add at least 3 platforms for now
        platforms[1] = this.physics.add.staticGroup();
        platforms[2] = this.physics.add.staticGroup();
        platforms[3] = this.physics.add.staticGroup();

        //  Here we create the ground.
        //  Scale it to fit the width of the game (the original sprite is 400x32 in size)
        platforms[platformIndex].create(400, 568, 'ground').setScale(2).refreshBody();

        //  Now let's create some ledges
        platforms[platformIndex].create(600, 400, 'ground');
        platforms[platformIndex].create(50, 250, 'ground');
        platforms[platformIndex].create(750, 220, 'ground');

        // The player and its settings

        // Randomize player sprite
        let dudeArray = [
            'dude1',
            'dude2'
        ];

        let randomDude = Math.floor(Math.random() * dudeArray.length);

        const dude = dudeArray[randomDude];

        player = this.physics.add.sprite(100, 450, dude);

        //  Player physics properties. Give the little guy a slight bounce.
        player.setBounce(0.2);
        player.setCollideWorldBounds(true);

        //  Our player animations, turning, walking left and walking right.
        this.anims.create({
            key: 'left',
            frames: this.anims.generateFrameNumbers(dude, {start: 0, end: 3}),
            frameRate: 10,
            repeat: -1
        });

        this.anims.create({
            key: 'turn',
            frames: [{key: dude, frame: 4}],
            frameRate: 20
        });

        this.anims.create({
            key: 'right',
            frames: this.anims.generateFrameNumbers(dude, {start: 5, end: 8}),
            frameRate: 10,
            repeat: -1
        });

        //  Input Events
        cursors = this.input.keyboard.addKeys(
            {
                up: Phaser.Input.Keyboard.KeyCodes.W,
                down: Phaser.Input.Keyboard.KeyCodes.S,
                left: Phaser.Input.Keyboard.KeyCodes.A,
                right: Phaser.Input.Keyboard.KeyCodes.D
            });

        //  Some stars to collect, 12 in total, evenly spaced 70 pixels apart along the x axis
        stars = this.physics.add.group({
            key: 'star',
            repeat: 11,
            setXY: {x: 12, y: 0, stepX: 70}
        });

        stars.children.iterate(function (child) {

            //  Give each star a slightly different bounce
            child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));

        });

        bombs = this.physics.add.group();

        //  The score
        scoreText = this.add.text(16, 16, 'Score: 0', {fontSize: '32px', fill: '#FFF'});

        //  Collide the player and the stars with the platforms
        this.physics.add.collider(player, platforms[platformIndex]);
        this.physics.add.collider(stars, platforms[platformIndex]);
        this.physics.add.collider(bombs, platforms[platformIndex]);

        //  Checks to see if the player overlaps with any of the stars, if he does call the collectStar function
        this.physics.add.overlap(player, stars, collectStar, null, this);

        this.physics.add.collider(player, bombs, hitBomb, null, this);

        // Add joystick
        // TODO: Doesn't work as expected. It holds the pressed cursor but should do for now.
        this.joyStick = this.plugins.get('rexvirtualjoystickplugin').add(this, {
            x: 400,
            y: 675,
            radius: 100,
            base: this.add.circle(0, 0, 40, 0x888888),
            thumb: this.add.circle(0, 0, 30, 0xcccccc),
            // dir: '8dir',   // 'up&down'|0|'left&right'|1|'4dir'|2|'8dir'|3
            // forceMin: 16,
            // enable: true
        })
            .on('update', joyStickState, this);

        // Setup instructions
        // Not sure why isMobile() is not working here, doing this for now.
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        if (isMobile) {
            this.instructionsText = configMobile.instructions
        } else {
            this.instructionsText = configDesktop.instructions
        }

        // Instructions
        instructions = this.add.text(16, 560, this.instructionsText, {fontSize: '32px', fill: '#fff'});

        // Start game with bomb
        var x = (player.x < 400) ? Phaser.Math.Between(400, 800) : Phaser.Math.Between(0, 400);

        var bomb = bombs.create(x, 16, 'bomb');
        bomb.setBounce(1);
        bomb.setCollideWorldBounds(true);
        bomb.setVelocity(Phaser.Math.Between(-200, 200), 20);
        bomb.allowGravity = false;
    }

    function update() {
        if (gameOver) {

            console.log("game over")

            $('#main').removeClass('hidden')
            $('#main').addClass('z-10')

            $('#game').addClass('game-over')

            game.destroy()

            return false
        }

        // Keyboard and mobile joystick
        if (cursors.left.isDown || this.mobileCursorKeys === 'left') {
            player.setVelocityX(-160);

            player.anims.play('left', true);
        } else if (cursors.right.isDown || this.mobileCursorKeys === 'right') {
            player.setVelocityX(160);

            player.anims.play('right', true);
        } else {
            player.setVelocityX(0);

            player.anims.play('turn');
        }

        if ((cursors.up.isDown || this.mobileCursorKeys === 'up') && player.body.touching.down) {
            player.setVelocityY(-330);
        }
    }

    function joyStickState() {
        const cursorKeys = this.joyStick.createCursorKeys();
        for (const name in cursorKeys) {
            if (cursorKeys[name].isDown) {
                this.mobileCursorKeys = `${name}`
            }
        }
    }

    function collectStar(player, star) {
        star.disableBody(true, true);

        //  Add and update the score
        score += 10;
        scoreText.setText('Score: ' + score);

        // Change background on score
        if ((score % 360) === 0) {

            // Platforms
            platforms[platformIndex].clear(true, true);

            platformIndex++

            console.log("platformIndex")
            console.log(platformIndex)

            // Reset background
            if (platformIndex === 4) {
                platformIndex = 1
            }

            changePlatform(platformIndex)

            //  Reset colliders
            //  Collide the player and the stars with the platforms
            this.physics.add.collider(player, platforms[platformIndex]);
            this.physics.add.collider(stars, platforms[platformIndex]);
            this.physics.add.collider(bombs, platforms[platformIndex]);

            // Backgrounds
            skyIndex++

            // Reset background
            if (skyIndex === 7) {
                skyIndex = 1
            }

            changeBackground('sky' + skyIndex)
        }

        if (stars.countActive(true) === 0) {
            //  A new batch of stars to collect
            stars.children.iterate(function (child) {

                child.enableBody(true, child.x, 0, true, true);

            });

            var x = (player.x < 400) ? Phaser.Math.Between(400, 800) : Phaser.Math.Between(0, 400);

            var bomb = bombs.create(x, 16, 'bomb');
            bomb.setBounce(1);
            bomb.setCollideWorldBounds(true);
            bomb.setVelocity(Phaser.Math.Between(-200, 200), 20);
            bomb.allowGravity = false;

        }
    }

    function hitBomb(player, bomb) {
        this.physics.pause();

        player.setTint(0xff0000);

        player.anims.play('turn');

        gameOver = true;
    }

    function isMobile() {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        if (isMobile) {
            // User is accessing the page on a mobile device
            // console.log("Mobile device detected");

            return true
        } else {
            // User is accessing the page on a desktop device
            // console.log("Desktop device detected");

            return false
        }
    }

    function changeBackground(key) {

        sky.setTexture(key, 0);
    }

    function changePlatform(platformIndex) {

        // Default
        if (platformIndex === 1) {

            // Ground
            platforms[platformIndex].create(400, 568, 'ground').setScale(2).refreshBody();

            // Ledges
            platforms[platformIndex].create(600, 400, 'ground');
            platforms[platformIndex].create(50, 250, 'ground');
            platforms[platformIndex].create(750, 220, 'ground');
        } else if (platformIndex === 2) {

            // Ground
            platforms[platformIndex].create(400, 568, 'ground').setScale(2).refreshBody();

            // Ledges
            platforms[platformIndex].create(18, 170, 'ground-s');
            platforms[platformIndex].create(325, 220, 'ground-s');
            platforms[platformIndex].create(609, 190, 'ground-s');
            platforms[platformIndex].create(800, 390, 'ground-s');
            platforms[platformIndex].create(260, 370, 'ground');
        } else if (platformIndex === 3) {

            // Ground
            platforms[platformIndex].create(150, 568, 'ground-s').setScale(2).refreshBody();
            platforms[platformIndex].create(450, 568, 'ground-s').setScale(2).refreshBody();

            // Ledges
            platforms[platformIndex].create(18, 170, 'ground-s');
            platforms[platformIndex].create(325, 220, 'ground-s');
            platforms[platformIndex].create(609, 190, 'ground-s');
            platforms[platformIndex].create(710, 410, 'ground-s');
            platforms[platformIndex].create(750, 410, 'ground-s');
            platforms[platformIndex].create(260, 370, 'ground');

            // Add bombs

            // Left
            bombs.create(3, 595, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(10, 595, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(20, 594, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(30, 598, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(37, 597, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(50, 596, 'bomb').setImmovable(false).body.allowGravity = false;

            // Mid
            bombs.create(249, 597, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(260, 595, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(267, 599, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(289, 598, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(280, 595, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(309, 599, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(330, 599, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(330, 594, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(353, 595, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(300, 596, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(320, 594, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(340, 598, 'bomb').setImmovable(false).body.allowGravity = false;

            // Right
            bombs.create(550, 595, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(560, 596, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(571, 599, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(580, 598, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(589, 598, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(600, 595, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(609, 594, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(620, 597, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(627, 594, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(640, 598, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(651, 594, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(660, 597, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(671, 599, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(680, 597, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(690, 593, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(700, 595, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(710, 599, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(720, 596, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(730, 593, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(740, 600, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(748, 598, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(760, 594, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(772, 596, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(780, 599, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(788, 597, 'bomb').setImmovable(false).body.allowGravity = false;
            bombs.create(792, 597, 'bomb').setImmovable(false).body.allowGravity = false;
        }

    }

</script>

</body>
</html>